(function(){var e,t;e=this,t=function(){var e,c={startStopTimes:{},idleTimeoutMs:3e4,currentIdleTimeMs:0,checkStateRateMs:250,active:!1,idle:!1,currentPageName:"default-page-name",timeElapsedCallbacks:[],userLeftCallbacks:[],userReturnCallbacks:[],pageloadmetric:0,trackTimeOnElement:function(e){var t=document.getElementById(e);t&&(t.addEventListener("mouseover",function(){c.startTimer(t)}),t.addEventListener("mousemove",function(){c.startTimer(t)}),t.addEventListener("mouseleave",function(){c.stopTimer(t)}),t.addEventListener("keypress",function(){c.startTimer(t)}),t.addEventListener("focus",function(){c.startTimer(t)}))},getTimeOnElementInSeconds:function(e){var t=c.getTimeOnPageInSeconds(e);return t||0},startTimer:function(e){if(e||(e=c.currentPageName),void 0===c.startStopTimes[e])c.startStopTimes[e]=[];else{var t=c.startStopTimes[e],n=t[t.length-1];if(void 0!==n&&void 0===n.stopTime)return}c.startStopTimes[e].push({startTime:new Date,stopTime:void 0,pageload:c.pageloadmetric,clicks:0,scrolls:0}),c.active=!0},stopAllTimers:function(){for(var e=Object.keys(c.startStopTimes),t=0;t<e.length;t++)c.stopTimer(e[t])},stopTimer:function(e){e||(e=c.currentPageName);var t=c.startStopTimes[e];void 0!==t&&0!==t.length&&void 0===t[t.length-1].stopTime&&(t[t.length-1].stopTime=new Date)},getTimeOnCurrentPageInSeconds:function(){return c.getTimeOnPageInSeconds(c.currentPageName)},getTimeOnPageInSeconds:function(e){return void 0===c.getTimeOnPageInMilliseconds(e).tottime?void 0:{tt:c.getTimeOnPageInMilliseconds(e).tottime/1e3,pl:c.getTimeOnPageInMilliseconds(e).pageload}},getTimeOnCurrentPageInMilliseconds:function(){return c.getTimeOnPageInMilliseconds(c.currentPageName)},getTimeOnPageInMilliseconds:function(e){var t=c.startStopTimes[e];if(void 0!==t){for(var n=0,i=0;i<t.length;i++){var o=t[i].startTime,s=t[i].stopTime,a=t[i].pageload;void 0===s&&(s=new Date),n+=s-o}return{tottime:Number(n),pageload:a}}},getTotalClickCountOnPage:function(e){var t=c.startStopTimes[e];if(void 0!==t&&0!==t.length){for(var n=0,i=0;i<t.length;i++)n+=t[i].clicks;return n}},getTotalScrollCountOnPage:function(e){var t=c.startStopTimes[e];if(void 0!==t&&0!==t.length){for(var n=0,i=0;i<t.length;i++)n+=t[i].scrolls;return n}},getTimeOnAllPagesInSeconds:function(){for(var e=[],t=Object.keys(c.startStopTimes),n=0;n<t.length;n++){var i=t[n],o=c.getTimeOnPageInSeconds(i).tt,s=c.getTimeOnPageInSeconds(i).pl,a=c.getTotalClickCountOnPage(i);console.log("allTimes",i,a);var r=c.getTotalScrollCountOnPage(i);e.push({pageName:i,timeOnPage:o,clicks:a,scrolls:r,PageLoad:s})}return e},handleClicks:function(){var e=c.startStopTimes[c.currentPageName],t=e.length-1,n=e[t].clicks;n+=1,c.startStopTimes[c.currentPageName][t].clicks=n},handleScroll:function(){clearTimeout(e),e=setTimeout(function(){var e,t,n;e=c.startStopTimes[c.currentPageName],t=e.length-1,n=e[t].scrolls,n+=1,c.startStopTimes[c.currentPageName][t].scrolls=n},66)},setIdleDurationInSeconds:function(e){var t=parseFloat(e);if(!1!==isNaN(t))throw{name:"InvalidDurationException",message:"An invalid duration time ("+e+") was provided."};return c.idleTimeoutMs=1e3*e,this},setCurrentPageName:function(e){return c.currentPageName=e,this},setPageLoad:function(e){return c.pageloadmetric=e,this},resetRecordedPageTime:function(e){delete c.startStopTimes[e]},resetAllRecordedPageTimes:function(){for(var e=Object.keys(c.startStopTimes),t=0;t<e.length;t++)c.resetRecordedPageTime(e[t])},resetIdleCountdown:function(){c.idle&&c.triggerUserHasReturned(),c.idle=!1,c.currentIdleTimeMs=0},callWhenUserLeaves:function(e,t){this.userLeftCallbacks.push({callback:e,numberOfTimesToInvoke:t})},callWhenUserReturns:function(e,t){this.userReturnCallbacks.push({callback:e,numberOfTimesToInvoke:t})},triggerUserHasReturned:function(){if(!c.active)for(var e=0;e<this.userReturnCallbacks.length;e++){var t=this.userReturnCallbacks[e],n=t.numberOfTimesToInvoke;(isNaN(n)||void 0===n||0<n)&&(t.numberOfTimesToInvoke-=1,t.callback())}c.startTimer()},triggerUserHasLeftPage:function(){if(c.active)for(var e=0;e<this.userLeftCallbacks.length;e++){var t=this.userLeftCallbacks[e],n=t.numberOfTimesToInvoke;(isNaN(n)||void 0===n||0<n)&&(t.numberOfTimesToInvoke-=1,t.callback())}c.stopAllTimers()},callAfterTimeElapsedInSeconds:function(e,t){c.timeElapsedCallbacks.push({timeInSeconds:e,callback:t,pending:!0})},checkState:function(){for(var e=0;e<c.timeElapsedCallbacks.length;e++)c.timeElapsedCallbacks[e].pending&&c.getTimeOnCurrentPageInSeconds()>c.timeElapsedCallbacks[e].timeInSeconds&&(c.timeElapsedCallbacks[e].callback(),c.timeElapsedCallbacks[e].pending=!1);!1===c.idle&&c.currentIdleTimeMs>c.idleTimeoutMs?(c.idle=!0,c.triggerUserHasLeftPage()):c.currentIdleTimeMs+=c.checkStateRateMs},visibilityChangeEventName:void 0,hiddenPropName:void 0,listenForVisibilityEvents:function(){void 0!==document.hidden?(c.hiddenPropName="hidden",c.visibilityChangeEventName="visibilitychange"):void 0!==document.mozHidden?(c.hiddenPropName="mozHidden",c.visibilityChangeEventName="mozvisibilitychange"):void 0!==document.msHidden?(c.hiddenPropName="msHidden",c.visibilityChangeEventName="msvisibilitychange"):void 0!==document.webkitHidden&&(c.hiddenPropName="webkitHidden",c.visibilityChangeEventName="webkitvisibilitychange"),document.addEventListener(c.visibilityChangeEventName,function(){document[c.hiddenPropName]?c.triggerUserHasLeftPage():c.triggerUserHasReturned()},!1),window.addEventListener("blur",function(){c.triggerUserHasLeftPage()}),window.addEventListener("focus",function(){c.triggerUserHasReturned()}),document.addEventListener("mousemove",function(){c.resetIdleCountdown()}),document.addEventListener("keyup",function(){c.resetIdleCountdown()}),document.addEventListener("touchstart",function(){c.resetIdleCountdown()}),window.addEventListener("scroll",function(){c.resetIdleCountdown(),c.handleScroll()},!1),window.addEventListener("click",function(){c.handleClicks()}),setInterval(function(){c.checkState()},c.checkStateRateMs)},websocket:void 0,websocketHost:void 0,setUpWebsocket:function(t){if(window.WebSocket&&t){var e=t.websocketHost;try{c.websocket=new WebSocket(e),window.onbeforeunload=function(e){c.sendCurrentTime(t.appId)},c.websocket.onopen=function(){c.sendInitWsRequest(t.appId)},c.websocket.onerror=function(e){console&&console.log("Error occurred in websocket connection: "+e)},c.websocket.onmessage=function(e){console&&console.log(e.data)}}catch(e){console&&console.error("Failed to connect to websocket host.  Error:"+e)}}return this},websocketSend:function(e){c.websocket.send(JSON.stringify(e))},sendCurrentTime:function(e){var t={type:"INSERT_TIME",appId:e,timeOnPageMs:c.getTimeOnCurrentPageInMilliseconds(),pageName:c.currentPageName};c.websocketSend(t)},sendInitWsRequest:function(e){var t={type:"INIT",appId:e};return c.websocketSend(t),t},initialize:function(e){var t=c.idleTimeoutMs||30,n=c.currentPageName||"default-page-name",i=c.pageloadmetric||0,o=void 0;e&&(t=e.idleTimeoutInSeconds||t,n=e.currentPageName||n,i=e.pageloadmetric||i,o=e.websocketOptions),c.setIdleDurationInSeconds(t).setCurrentPageName(n).setPageLoad(i).setUpWebsocket(o).listenForVisibilityEvents(),c.startTimer()}};return c},"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define([],function(){return e.TimeMe=t()}):e.TimeMe=t()}).call(this);
